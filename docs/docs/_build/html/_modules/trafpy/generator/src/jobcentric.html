

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>trafpy.generator.src.jobcentric &mdash; TrafPy 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> TrafPy
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Contribute.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../License.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Citing.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../setup.html">setup module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../trafpy.html">trafpy package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">TrafPy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>trafpy.generator.src.jobcentric</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for trafpy.generator.src.jobcentric</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">trafpy.generator.src.dists</span> <span class="kn">import</span> <span class="n">val_dists</span><span class="p">,</span> <span class="n">node_dists</span>
<span class="kn">from</span> <span class="nn">trafpy.generator.src</span> <span class="kn">import</span> <span class="n">tools</span>
<span class="kn">from</span> <span class="nn">trafpy.generator.src.flowcentric</span> <span class="kn">import</span> <span class="n">FlowPacker</span><span class="p">,</span> <span class="n">duplicate_demands_in_demand_data_dict</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span> <span class="c1"># progress bar</span>




<div class="viewcode-block" id="JobGenerator"><a class="viewcode-back" href="../../../../trafpy.generator.src.html#trafpy.generator.src.jobcentric.JobGenerator">[docs]</a><span class="k">class</span> <span class="nc">JobGenerator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">eps</span><span class="p">,</span>
                 <span class="n">node_dist</span><span class="p">,</span>
                 <span class="n">flow_size_dist</span><span class="p">,</span>
                 <span class="n">interarrival_time_dist</span><span class="p">,</span>
                 <span class="n">num_ops_dist</span><span class="p">,</span>
                 <span class="n">network_load_config</span><span class="p">,</span>
                 <span class="n">c</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                 <span class="n">run_time_gaussian_noise_mean</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">run_time_gaussian_noise_sd</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                 <span class="n">round_op_run_time_to_nearest</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
                 <span class="n">prob_data_dependency</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                 <span class="n">use_multiprocessing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">min_num_demands</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
                 <span class="n">max_num_demands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">jensen_shannon_distance_threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">min_last_demand_arrival_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">auto_node_dist_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">check_dont_exceed_one_ep_load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">bidirectional_links</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">print_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Args:</span>
<span class="sd">            network_load_config (dict): Dict of form {&#39;network_rate_capacity&#39;: &lt;int/float&gt;, &#39;target_load_fraction&#39;: &lt;float&gt;, &#39;disable_timeouts&#39;: &lt;bool&gt;, &#39;return_new_interarrival_time_dist&#39;: &lt;bool&gt;},</span>
<span class="sd">                where network_rate_capacity is the maximum rate (in e.g. Gbps) at which</span>
<span class="sd">                information can be reliably transmitted over the communication network</span>
<span class="sd">                which the demand data will be inserted into, and where target_load_fraction</span>
<span class="sd">                is the fraction of the network rate capacity being requested by the demands</span>
<span class="sd">                (e.g. target_load_fraction=0.75 would generate demands which request</span>
<span class="sd">                a load that is 75% of the network rate capacity from the first to </span>
<span class="sd">                the last demand arriving). If &#39;target_load_fraction&#39; is None, won&#39;t adjust</span>
<span class="sd">                inter arrival time dist at all to meet network load.</span>
<span class="sd">            auto_node_dist_correction (bool): Set to True if you want TrafPy to</span>
<span class="sd">                automatically make invalid node distributions valid. If True, invalid</span>
<span class="sd">                node distributions where more load is being assigned to a end point</span>
<span class="sd">                link than the end point link has bandwidth will be changed by </span>
<span class="sd">                removing the invalid end point link load to its maximum 1.0 load</span>
<span class="sd">                and distributing the removed load across all other valid links</span>
<span class="sd">                uniformly.</span>
<span class="sd">            max_num_demands (int): If not None, will not exceed this number of demands,</span>
<span class="sd">                which can help if you find you are exceeding memory limitations in</span>
<span class="sd">                your simulations. However, this will also mean that the (1) jensen_shannon_distance_threshold</span>
<span class="sd">                and (2) min_last_demand_arrival_time you specifiy may not be met. To</span>
<span class="sd">                ensure these are met, you must set max_num_demands to None.</span>
<span class="sd">            jensen_shannon_distance_threshold (float): Maximum jensen shannon distance</span>
<span class="sd">                required of generated random variables w.r.t. discretised dist they&#39;re generated from.</span>
<span class="sd">                Must be between 0 and 1. Distance of 0 -&gt; distributions are exactly the same.</span>
<span class="sd">                Distance of 1 -&gt; distributions are not at all similar.</span>
<span class="sd">                https://medium.com/datalab-log/measuring-the-statistical-similarity-between-two-samples-using-jensen-shannon-and-kullback-leibler-8d05af514b15</span>
<span class="sd">                N.B. To meet threshold, this function will keep doubling num_demands</span>
<span class="sd">            check_dont_exceed_one_ep_load (bool): If True, when packing flows (assigning</span>
<span class="sd">                src-dst node pairs according to specified node distribution), will ensure</span>
<span class="sd">                that don&#39;t exceed 1.0 load on any end points. If this is not possible,</span>
<span class="sd">                will raise an Exception. If False, no exception will be raised, but run</span>
<span class="sd">                risk of exceeding 1.0 end point load, which for some users might be</span>
<span class="sd">                detrimental to their system.</span>
<span class="sd">            bidirectional_links (bool): If True, assume each network link is split</span>
<span class="sd">                into 2 ports; src port and dst port (i.e. the link is bidirectional).</span>
<span class="sd">                If False, treat network links as separate uni-directional links.</span>
<span class="sd">                In uni-directional case, will assume ep_link_capacity of network</span>
<span class="sd">                is for src OR dst link and pack by doubling ep_link_capacity and packing</span>
<span class="sd">                links with src-dst pairs. In bidirectional case,</span>
<span class="sd">                assume ep_link_capacity is for both src and dst ports, therefore no need</span>
<span class="sd">                to double and can pack links with src-dst pairs as they are.</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_dist</span> <span class="o">=</span> <span class="n">node_dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow_size_dist</span> <span class="o">=</span> <span class="n">flow_size_dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interarrival_time_dist</span> <span class="o">=</span> <span class="n">interarrival_time_dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_ops_dist</span> <span class="o">=</span> <span class="n">num_ops_dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_num_demands</span> <span class="o">=</span> <span class="n">max_num_demands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_demands</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_num_demands</span><span class="p">,</span> <span class="n">max_num_demands</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_load_config</span> <span class="o">=</span> <span class="n">network_load_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob_data_dependency</span> <span class="o">=</span> <span class="n">prob_data_dependency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_time_gaussian_noise_mean</span> <span class="o">=</span> <span class="n">run_time_gaussian_noise_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_time_gaussian_noise_sd</span> <span class="o">=</span> <span class="n">run_time_gaussian_noise_sd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">round_op_run_time_to_nearest</span> <span class="o">=</span> <span class="n">round_op_run_time_to_nearest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_multiprocessing</span> <span class="o">=</span> <span class="n">use_multiprocessing</span>
        <span class="c1"># self.use_multiprocessing = True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_last_demand_arrival_time</span> <span class="o">=</span> <span class="n">min_last_demand_arrival_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_node_dist_correction</span> <span class="o">=</span> <span class="n">auto_node_dist_correction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jensen_shannon_distance_threshold</span> <span class="o">=</span> <span class="n">jensen_shannon_distance_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_dont_exceed_one_ep_load</span> <span class="o">=</span> <span class="n">check_dont_exceed_one_ep_load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_links</span> <span class="o">=</span> <span class="n">bidirectional_links</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_data</span> <span class="o">=</span> <span class="n">print_data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_pairs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_to_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_node</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_network_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_load_config</span><span class="p">[</span><span class="s1">&#39;target_load_fraction&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_load_config</span><span class="p">[</span><span class="s1">&#39;target_load_fraction&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Target load fraction </span><span class="si">{}</span><span class="s1"> is invalid. Must be &lt;= 0.95.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_load_config</span><span class="p">[</span><span class="s1">&#39;target_load_fraction&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_dont_exceed_one_ep_load</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: check_dont_exceed_one_ep_load is set to False. This may result in end point loads going above 1.0, which for some users might be detrimental to the systems they want to test.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="JobGenerator.create_job_centric_demand_data"><a class="viewcode-back" href="../../../../trafpy.generator.src.html#trafpy.generator.src.jobcentric.JobGenerator.create_job_centric_demand_data">[docs]</a>    <span class="k">def</span> <span class="nf">create_job_centric_demand_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        N.B. Currently only applying jensen_shannon_distance_threshold requirement</span>
<span class="sd">        to num_ops, not to flow size or interarrival time etc. Do this because</span>
<span class="sd">        otherwise may require far too many demands (jobs) -&gt; very memory intensive.</span>
<span class="sd">        In future, should try to fix this and apply threshold requirement to all</span>
<span class="sd">        distributions.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># multiprocessing params</span>
        <span class="n">num_processes</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">maxtasksperchild</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># num ops</span>
        <span class="n">num_ops</span> <span class="o">=</span> <span class="n">val_dists</span><span class="o">.</span><span class="n">gen_rand_vars_from_discretised_dist</span><span class="p">(</span><span class="n">unique_vars</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ops_dist</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                                                <span class="n">probabilities</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ops_dist</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                                                <span class="n">num_demands</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_demands</span><span class="p">,</span>
                                                                <span class="n">jensen_shannon_distance_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jensen_shannon_distance_threshold</span><span class="p">)</span>
        <span class="c1"># update num_demands in case jensen-shannon distance threshold required num_demands to be increased</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_demands</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">num_ops</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_demands</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_demands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_demands</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_demands</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: max_num_demands is </span><span class="si">{}</span><span class="s1"> but needed </span><span class="si">{}</span><span class="s1"> jobs to meet jensen_shannon_distance_threshold </span><span class="si">{}</span><span class="s1">. Capping num_demands to max_num_demands, therefore may not meet jensen_shannon_distance_threshold specified. Increase max_num_demands to ensure you meet the jensen_shannon_distance_threshold.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_num_demands</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">num_ops</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">jensen_shannon_distance_threshold</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_demands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_demands</span>
                <span class="n">num_ops</span> <span class="o">=</span> <span class="n">val_dists</span><span class="o">.</span><span class="n">gen_rand_vars_from_discretised_dist</span><span class="p">(</span><span class="n">unique_vars</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ops_dist</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                                                        <span class="n">probabilities</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ops_dist</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                                                        <span class="n">num_demands</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_demands</span><span class="p">)</span>

        <span class="c1"># init job graphs</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_job_graphs</span><span class="p">(</span><span class="n">num_ops</span><span class="o">=</span><span class="n">num_ops</span><span class="p">,</span>
                                     <span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
                                     <span class="n">prob_data_dependency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prob_data_dependency</span><span class="p">,</span>
                                     <span class="n">use_multiprocessing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_multiprocessing</span><span class="p">,</span>
                                     <span class="n">print_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">print_data</span><span class="p">)</span>
        
        <span class="c1"># flow sizes</span>
        <span class="c1"># total num flows == total num data dependencies (some will not become flows if packer sets src == dst)</span>
        <span class="c1"># N.B. Might actually work out perfectly without dropped flows if FlowPacker never allocates src==dst?</span>
        <span class="n">total_num_data_deps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="n">total_num_data_deps</span> <span class="o">+=</span> <span class="n">job</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;num_data_deps&#39;</span><span class="p">]</span>
        <span class="n">flow_sizes</span> <span class="o">=</span> <span class="n">val_dists</span><span class="o">.</span><span class="n">gen_rand_vars_from_discretised_dist</span><span class="p">(</span><span class="n">unique_vars</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_size_dist</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                                                   <span class="n">probabilities</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_size_dist</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                                                   <span class="n">num_demands</span><span class="o">=</span><span class="n">total_num_data_deps</span><span class="p">)</span>

        <span class="c1"># job interarrival times</span>
        <span class="n">interarrival_times</span> <span class="o">=</span> <span class="n">val_dists</span><span class="o">.</span><span class="n">gen_rand_vars_from_discretised_dist</span><span class="p">(</span><span class="n">unique_vars</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interarrival_time_dist</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                                                           <span class="n">probabilities</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interarrival_time_dist</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                                                           <span class="n">num_demands</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_demands</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_load_config</span><span class="p">[</span><span class="s1">&#39;target_load_fraction&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># adjust overall interarrival time dist until overall load &lt;= user-specified load</span>
            <span class="n">interarrival_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_demand_load</span><span class="p">(</span><span class="n">flow_sizes</span><span class="p">,</span>
                                                          <span class="n">interarrival_times</span><span class="p">)</span>

        <span class="c1"># corresponding job event (arrival) times</span>
        <span class="n">event_times</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">gen_event_times</span><span class="p">(</span><span class="n">interarrival_times</span><span class="p">)</span>
        <span class="n">index</span><span class="p">,</span> <span class="n">event_times_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">event_times</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">event_times</span><span class="p">)</span>

        <span class="c1"># job ids</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;job_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_demands</span><span class="p">)]</span>
        <span class="n">establish</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_demands</span><span class="p">)]</span>

        <span class="c1"># flow ids</span>
        <span class="c1"># flow_ids = [&#39;flow_&#39;+str(i) for i in range(total_num_data_deps)]</span>
        <span class="n">flow_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># set which flows will be allocated to which jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id_to_flow_indices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">last_flow_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">jobs</span><span class="p">):</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_id_to_flow_indices</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">last_flow_idx</span><span class="p">,</span> <span class="n">last_flow_idx</span><span class="o">+</span><span class="n">job</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;num_data_deps&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">f_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">last_flow_idx</span><span class="p">,</span> <span class="n">last_flow_idx</span><span class="o">+</span><span class="n">job</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;num_data_deps&#39;</span><span class="p">]):</span>
                <span class="n">unique_id</span> <span class="o">=</span> <span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;_flow_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_idx</span><span class="p">)</span>
                <span class="n">flow_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_id</span><span class="p">)</span>
            <span class="n">last_flow_idx</span> <span class="o">+=</span> <span class="n">job</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;num_data_deps&#39;</span><span class="p">]</span>

        <span class="c1"># pack the flows into src-dst pairs to meet src-dst pair load config requirements of node_dist</span>
        <span class="n">packer</span> <span class="o">=</span> <span class="n">FlowPacker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">node_dist</span><span class="p">,</span>
                            <span class="n">flow_ids</span><span class="p">,</span>
                            <span class="n">flow_sizes</span><span class="p">,</span>
                            <span class="n">interarrival_times</span><span class="p">,</span>
                            <span class="n">network_load_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network_load_config</span><span class="p">,</span>
                            <span class="n">auto_node_dist_correction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_node_dist_correction</span><span class="p">,</span>
                            <span class="n">check_dont_exceed_one_ep_load</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">check_dont_exceed_one_ep_load</span><span class="p">,</span>
                            <span class="n">bidirectional_links</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_links</span><span class="p">)</span>
        <span class="n">packed_flows</span> <span class="o">=</span> <span class="n">packer</span><span class="o">.</span><span class="n">pack_the_flows</span><span class="p">()</span>


        
        <span class="c1"># allocate flows to data deps in jobs and allocate attrs to each flow</span>
        <span class="c1"># pbar = tqdm(total=len(jobs),</span>
                    <span class="c1"># desc=&#39;Allocating job flow attrs&#39;,</span>
                    <span class="c1"># miniters=1, </span>
                    <span class="c1"># # mininterval=1,</span>
                    <span class="c1"># # maxinterval=1, # 2</span>
                    <span class="c1"># leave=False,</span>
                    <span class="c1"># smoothing=0) # 1</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># for multiprocessing</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">job_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Allocating job flow attrs...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_multiprocessing</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_processes</span><span class="p">,</span><span class="n">maxtasksperchild</span><span class="o">=</span><span class="n">maxtasksperchild</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_allocate_job_flow_attrs</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">job_idx</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">packed_flows</span><span class="p">,</span> <span class="kc">None</span><span class="p">,))</span> <span class="k">for</span> <span class="n">job</span><span class="p">,</span> <span class="n">job_idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)))]</span>
            <span class="c1"># results = [pool.apply_async(self._allocate_job_flow_attrs, args=(job, job_idx, job_ids, packed_flows, None,), callback=lambda _: pbar.update(1)) for job, job_idx in zip(jobs, range(len(jobs)))]</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">pool</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_jobs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                <span class="n">_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_allocate_job_flow_attrs</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">job_idx</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">packed_flows</span><span class="p">))</span>
                <span class="n">job_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">_jobs</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># pbar.close()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Allocated flow attrs for </span><span class="si">{}</span><span class="s1"> jobs in </span><span class="si">{}</span><span class="s1"> seconds.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">),</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>

        <span class="c1"># set job op run times</span>
        <span class="c1"># pbar = tqdm(total=len(jobs),</span>
                <span class="c1"># desc=&#39;Setting op run times&#39;,</span>
                    <span class="c1"># miniters=1, </span>
                    <span class="c1"># # mininterval=1,</span>
                    <span class="c1"># # maxinterval=1, # 2</span>
                    <span class="c1"># leave=False,</span>
                    <span class="c1"># smoothing=0) # 1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting op run times...&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">_jobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_job_op_run_times</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> 
                                           <span class="bp">self</span><span class="o">.</span><span class="n">run_time_gaussian_noise_mean</span><span class="p">,</span> 
                                           <span class="bp">self</span><span class="o">.</span><span class="n">run_time_gaussian_noise_sd</span><span class="p">,</span> 
                                           <span class="bp">self</span><span class="o">.</span><span class="n">round_op_run_time_to_nearest</span><span class="p">)</span>
            <span class="c1"># pbar.update(1)</span>
            <span class="n">_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">_jobs</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># pbar.close()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Set op run times of </span><span class="si">{}</span><span class="s1"> jobs in </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">),</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>

        <span class="n">_jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">]</span>

        <span class="n">demand_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;job_id&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)[</span><span class="n">index</span><span class="p">],</span>
                       <span class="s1">&#39;job&#39;</span><span class="p">:</span> <span class="n">_jobs</span><span class="p">,</span>
                       <span class="s1">&#39;event_time&#39;</span><span class="p">:</span> <span class="n">event_times_sorted</span><span class="p">,</span>
                       <span class="s1">&#39;establish&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">establish</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                       <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">}</span>

        <span class="c1"># get flowcentric demand data</span>
        <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;flow_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_ids</span>
        <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;sn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;dn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;flow_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="n">packed_flows</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;sn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packed_flows</span><span class="p">[</span><span class="n">flow</span><span class="p">][</span><span class="s1">&#39;src&#39;</span><span class="p">])</span>
            <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;dn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packed_flows</span><span class="p">[</span><span class="n">flow</span><span class="p">][</span><span class="s1">&#39;dst&#39;</span><span class="p">])</span>
            <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;flow_size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packed_flows</span><span class="p">[</span><span class="n">flow</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_last_demand_arrival_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># duplicate demands until get duration &gt;= user-specified duration</span>
            <span class="n">adjustment_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_last_demand_arrival_time</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;event_time&#39;</span><span class="p">])</span>
            <span class="n">num_duplications</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">adjustment_factor</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_demands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">num_duplications</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_demands</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARING: max_num_demands is </span><span class="si">{}</span><span class="s1"> but have specified min_last_demand_arrival_time </span><span class="si">{}</span><span class="s1">. Would need </span><span class="si">{}</span><span class="s1"> demands to reach this min_last_demand_arrival_time, therefore must increase max_num_demands (or set to None) if you want to meet this min_last_demand_arrival_time.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_num_demands</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_last_demand_arrival_time</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">num_duplications</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">])))</span>
                    <span class="k">return</span> <span class="n">demand_data</span>
            <span class="k">if</span> <span class="n">num_duplications</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">demand_data</span> <span class="o">=</span> <span class="n">duplicate_demands_in_demand_data_dict</span><span class="p">(</span><span class="n">demand_data</span><span class="p">,</span> 
                                                                    <span class="n">num_duplications</span><span class="o">=</span><span class="n">num_duplications</span><span class="p">,</span>
                                                                    <span class="n">use_multiprocessing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                    <span class="n">num_processes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                    <span class="n">maxtasksperchild</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">demand_data</span></div>


    <span class="k">def</span> <span class="nf">_set_job_op_run_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">job</span><span class="p">,</span> 
                             <span class="n">run_time_gaussian_noise_mean</span><span class="p">,</span> 
                             <span class="n">run_time_gaussian_noise_sd</span><span class="p">,</span>
                             <span class="n">round_op_run_time_to_nearest</span><span class="p">,</span>
                             <span class="n">jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If doing multi processing i.e. generating multiple jobs in parallel,</span>
<span class="sd">        must give multiprocessing.Manager().list() object as jobs attr of this</span>
<span class="sd">        function so that function can append to multiprocessing manager list.</span>
<span class="sd">        If not doing multiprocessing, leave attr as jobs=None</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Assume flow sizes are given in Bytes, but that we want in MB to be able to apply below equation for generation op run times similar to DeepMind paper method https://arxiv.org/pdf/1905.02494.pdf</span>
        <span class="c1"># assuming this will give op run times in units of us</span>
        <span class="n">conversion</span> <span class="o">=</span> <span class="mf">1e6</span>

        <span class="n">run_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="c1"># set op run times</span>
            <span class="n">parent_op</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">parent_op_parent_flows</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span><span class="n">parent_op</span><span class="p">)</span>
            <span class="n">parent_op_child_flows</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">out_edges</span><span class="p">(</span><span class="n">parent_op</span><span class="p">)</span>
            <span class="n">size_input_flows</span><span class="p">,</span> <span class="n">size_output_flows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">parent_op_parent_flows</span><span class="p">:</span>
                <span class="n">size_input_flows</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;attr_dict&#39;</span><span class="p">][</span><span class="s1">&#39;flow_size&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">conversion</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">parent_op_child_flows</span><span class="p">:</span>
                <span class="n">size_output_flows</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;attr_dict&#39;</span><span class="p">][</span><span class="s1">&#39;flow_size&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">conversion</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent_op</span> <span class="o">==</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span>
                <span class="n">run_time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">run_time_gaussian_noise_mean</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="n">run_time_gaussian_noise_sd</span><span class="p">)</span>   
                <span class="n">info_size</span> <span class="o">=</span> <span class="n">size_input_flows</span><span class="o">+</span><span class="n">size_output_flows</span>
                <span class="n">run_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">info_size</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">info_size</span><span class="p">))</span>
                <span class="n">run_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run_time</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">flow</span><span class="p">][</span><span class="s1">&#39;attr_dict&#39;</span><span class="p">][</span><span class="s1">&#39;parent_op_run_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_time</span>
        
        <span class="c1"># set list of op run times as global graph attr</span>
        <span class="n">job</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;op_run_times&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_times</span>
        <span class="n">job</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;sum_op_run_times&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">run_times</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">jobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">job</span>






    <span class="k">def</span> <span class="nf">_allocate_job_flow_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">job</span><span class="p">,</span> 
                                 <span class="n">job_idx</span><span class="p">,</span> 
                                 <span class="n">job_ids</span><span class="p">,</span> 
                                 <span class="n">flows</span><span class="p">,</span> 
                                 <span class="n">jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If doing multi processing i.e. generating multiple jobs in parallel,</span>
<span class="sd">        must give multiprocessing.Manager().list() object as jobs attr of this</span>
<span class="sd">        function so that function can append to multiprocessing manager list.</span>
<span class="sd">        If not doing multiprocessing, leave attr as jobs=None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_ids</span><span class="p">[</span><span class="n">job_idx</span><span class="p">]</span>
        <span class="n">job</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_id</span>

        <span class="n">sum_flow_info</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># get flows allocated to this job&#39;s data deps</span>
        <span class="n">flow_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id_to_flow_indices</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">flows</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">flow_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">flow_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

        <span class="c1"># go through edges going out of each op in job DAG</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">out_edges</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">parent_dep_edges</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span><span class="n">op</span><span class="p">)]</span>
            <span class="n">parent_dep_flow_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">parent_dep_edges</span><span class="p">:</span>
                <span class="n">parent_dep_flow_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;flow_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">dep</span><span class="p">][</span><span class="s1">&#39;dep_id&#39;</span><span class="p">]))</span>

            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
                <span class="c1"># src = job.nodes[flow[0]][&#39;attr_dict&#39;][&#39;machine&#39;]</span>
                <span class="c1"># dst = job.nodes[flow[1]][&#39;attr_dict&#39;][&#39;machine&#39;]</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s1">&#39;dependency&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># is a data dependency -&gt; becomes a flow</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
                    <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">flows</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="n">flows</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;dst&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># is a control dependency, just randomly choose src dst pair</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
                    <span class="n">dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>

                <span class="n">parent_op</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">child_op</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">child_dep_edges</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">child_op</span><span class="p">)</span> <span class="k">for</span> <span class="n">child_op</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">out_edges</span><span class="p">(</span><span class="n">child_op</span><span class="p">)]</span>

                <span class="n">child_dep_flow_ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">child_dep_edges</span><span class="p">:</span>
                    <span class="n">child_dep_flow_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;flow_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">dep</span><span class="p">][</span><span class="s1">&#39;dep_id&#39;</span><span class="p">]))</span>

                <span class="k">if</span> <span class="n">src</span> <span class="o">!=</span> <span class="n">dst</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s1">&#39;dependency&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># edge in job graph is a data dependency and becomes flow</span>
                    <span class="n">flow_size</span> <span class="o">=</span> <span class="n">flows</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                    <span class="n">sum_flow_info</span> <span class="o">+=</span> <span class="n">flow_size</span>
                    <span class="n">dependency_type</span> <span class="o">=</span> <span class="s1">&#39;data_dep&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># edge head &amp; tail at same machine or is control dep therefore not a flow</span>
                    <span class="c1"># if src == dst, is still a dependency but not a data dependency,</span>
                    <span class="c1"># therefore can register this as a control dependency</span>
                    <span class="n">flow_size</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">dependency_type</span> <span class="o">=</span> <span class="s1">&#39;control_dep&#39;</span>

                <span class="n">flow_stats</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sn&#39;</span><span class="p">:</span> <span class="n">src</span><span class="p">,</span>
                            <span class="s1">&#39;dn&#39;</span><span class="p">:</span> <span class="n">dst</span><span class="p">,</span>
                            <span class="s1">&#39;flow_size&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">flow_size</span><span class="p">),</span>
                            <span class="s1">&#39;flow_id&#39;</span><span class="p">:</span> <span class="s1">&#39;flow_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s1">&#39;dep_id&#39;</span><span class="p">]),</span>
                            <span class="s1">&#39;job_id&#39;</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">[</span><span class="n">job_idx</span><span class="p">],</span>
                            <span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="n">edge</span><span class="p">,</span>
                            <span class="s1">&#39;parent_dependency_edges&#39;</span><span class="p">:</span> <span class="n">parent_dep_edges</span><span class="p">,</span>
                            <span class="s1">&#39;parent_dependency_flow_ids&#39;</span><span class="p">:</span> <span class="n">parent_dep_flow_ids</span><span class="p">,</span>
                            <span class="s1">&#39;child_dependency_edges&#39;</span><span class="p">:</span> <span class="n">child_dep_edges</span><span class="p">,</span>
                            <span class="s1">&#39;child_dependency_flow_ids&#39;</span><span class="p">:</span> <span class="n">child_dep_flow_ids</span><span class="p">,</span>
                            <span class="s1">&#39;parent_op&#39;</span><span class="p">:</span> <span class="n">parent_op</span><span class="p">,</span>
                            <span class="s1">&#39;child_op&#39;</span><span class="p">:</span> <span class="n">child_op</span><span class="p">,</span>
                            <span class="s1">&#39;dependency_type&#39;</span><span class="p">:</span> <span class="n">dependency_type</span><span class="p">,</span>
                            <span class="s1">&#39;establish&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># None</span>
                            <span class="s1">&#39;event_time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span> <span class="c1"># None</span>
                
                <span class="n">job</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">attr_dict</span><span class="o">=</span><span class="n">flow_stats</span><span class="p">)</span>

        <span class="n">job</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;sum_flow_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_flow_info</span>

        <span class="k">if</span> <span class="n">jobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">job</span>













    <span class="k">def</span> <span class="nf">_calc_overall_load_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow_sizes</span><span class="p">,</span> <span class="n">interarrival_times</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns load rate (info units per unit time).&#39;&#39;&#39;</span>
        <span class="n">info_arrived</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_total_info_arrived</span><span class="p">(</span><span class="n">flow_sizes</span><span class="p">)</span>
        <span class="n">first_flow_arrival_time</span><span class="p">,</span> <span class="n">last_flow_arrival_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_first_last_flow_arrival_times</span><span class="p">(</span><span class="n">interarrival_times</span><span class="p">)</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">last_flow_arrival_time</span> <span class="o">-</span> <span class="n">first_flow_arrival_time</span>
        <span class="k">return</span> <span class="n">info_arrived</span><span class="o">/</span><span class="n">duration</span>

    <span class="k">def</span> <span class="nf">_calc_total_info_arrived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow_sizes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flow_sizes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_first_last_flow_arrival_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interarrival_times</span><span class="p">):</span>
        <span class="n">event_times</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">gen_event_times</span><span class="p">(</span><span class="n">interarrival_times</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">event_times</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">event_times</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_change_interarrival_times_by_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interarrival_times</span><span class="p">,</span> <span class="n">factor</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Updates self.interarrival_time_dist by a specified factor and returns new interarrival times.&#39;&#39;&#39;</span>
        <span class="n">new_interarrival_time_dist</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">rand_var</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interarrival_time_dist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_rand_var</span> <span class="o">=</span> <span class="n">rand_var</span> <span class="o">*</span> <span class="n">factor</span>
            <span class="n">new_interarrival_time_dist</span><span class="p">[</span><span class="n">new_rand_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span>

        <span class="c1"># update interarrival time dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interarrival_time_dist</span> <span class="o">=</span> <span class="n">new_interarrival_time_dist</span>

        <span class="c1"># gen new interarrival times</span>
        <span class="n">interarrival_times</span> <span class="o">*=</span> <span class="n">factor</span>

        <span class="k">return</span> <span class="n">interarrival_times</span>


    <span class="k">def</span> <span class="nf">_adjust_demand_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">flow_sizes</span><span class="p">,</span>
                            <span class="n">interarrival_times</span><span class="p">):</span>
        <span class="c1"># total info arriving (sum of flow sizes) is fixed</span>
        <span class="c1"># therefore to adjust load, must adjust duration by adjusting interarrival time dist</span>
        <span class="n">load_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_overall_load_rate</span><span class="p">(</span><span class="n">flow_sizes</span><span class="p">,</span> <span class="n">interarrival_times</span><span class="p">)</span>
        <span class="n">load_fraction</span> <span class="o">=</span> <span class="n">load_rate</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_load_config</span><span class="p">[</span><span class="s1">&#39;network_rate_capacity&#39;</span><span class="p">]</span>
        <span class="n">adjustment_factor</span> <span class="o">=</span> <span class="n">load_fraction</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_load_config</span><span class="p">[</span><span class="s1">&#39;target_load_fraction&#39;</span><span class="p">]</span> 
        <span class="n">interarrival_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_change_interarrival_times_by_factor</span><span class="p">(</span><span class="n">interarrival_times</span><span class="p">,</span> <span class="n">adjustment_factor</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">interarrival_times</span>
        

    
    <span class="k">def</span> <span class="nf">_init_job_graphs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">num_ops</span><span class="p">,</span>
                         <span class="n">c</span><span class="p">,</span>
                         <span class="n">prob_data_dependency</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                         <span class="n">use_multiprocessing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">print_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If doing multi processing i.e. generating multiple jobs in parallel,</span>
<span class="sd">        must give multiprocessing.Manager().list() object as jobs attr of this</span>
<span class="sd">        function so that function can append to multiprocessing manager list.</span>
<span class="sd">        If not doing multiprocessing, leave attr as jobs=None &amp; func will</span>
<span class="sd">        return a single job.</span>

<span class="sd">        num_ops (list): List of number of operations for each job. Length of list</span>
<span class="sd">            is number of jobs to generate.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># job_ids = [&#39;job_&#39;+str(idx) for idx in range(num_demands)]</span>
        <span class="c1"># jobs = np.array(np.zeros((len(job_ids))),dtype=object)</span>
        <span class="n">num_processes</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">num_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">num_ops</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># for multiprocessing</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">print_data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generating </span><span class="si">{}</span><span class="s1"> job computation graphs...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_jobs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">use_multiprocessing</span><span class="p">:</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">()</span> <span class="c1"># for demand generation</span>
            <span class="c1"># pool = multiprocessing.Pool(multiprocessing.cpu_count())</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">num_processes</span><span class="p">)</span>
            <span class="c1"># results = [pool.apply_async(self._init_job_graph, args=(int(val_dists.gen_rand_vars_from_discretised_dist(unique_vars=list(num_ops_dist.keys()),probabilities=list(num_ops_dist.values()),num_demands=1)[0]), c, prob_data_dependency, jobs, True,)) for _ in range(num_jobs)]</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_job_graph</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num_ops</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">c</span><span class="p">,</span> <span class="n">prob_data_dependency</span><span class="p">,</span> <span class="n">jobs</span><span class="p">,</span> <span class="n">print_data</span><span class="p">,))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_jobs</span><span class="p">)]</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">pool</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_jobs</span><span class="p">):</span>
                <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_job_graph</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num_ops</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">c</span><span class="p">,</span> <span class="n">prob_data_dependency</span><span class="p">))</span>

        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">print_data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generated </span><span class="si">{}</span><span class="s1"> job graphs in </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_jobs</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">jobs</span>

    <span class="k">def</span> <span class="nf">_init_job_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">num_ops</span><span class="p">,</span>
                        <span class="n">c</span><span class="p">,</span>
                        <span class="n">prob_data_dependency</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                        <span class="n">jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">print_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        num_ops (int): Number of operations in job graph to generate.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">prob_edge</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">num_ops</span><span class="p">)</span><span class="o">/</span><span class="n">num_ops</span><span class="p">)</span>

        <span class="n">threshold</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_ops</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">num_ops</span><span class="p">)</span><span class="o">/</span><span class="n">num_ops</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">prob_edge</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Threshold for graph_diameter&lt;=2 for n=</span><span class="si">{}</span><span class="s1"> graph is </span><span class="se">\</span>
<span class="s1">                    </span><span class="si">{}</span><span class="s1">, but your edge formation prob is </span><span class="si">{}</span><span class="s1">. Consider lowering </span><span class="se">\</span>
<span class="s1">                    prob_edge to &lt; </span><span class="si">{}</span><span class="s1"> to avoid low graph diameters (see </span><span class="se">\</span>
<span class="s1">                    https://www.cs.cmu.edu/~avrim/598/chap4only.pdf for more info)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_ops</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">prob_edge</span><span class="p">,</span><span class="n">threshold</span><span class="p">))</span>

        <span class="c1"># init undirected graph 0.05</span>
        <span class="n">undirected_job</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">erdos_renyi_graph</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">num_ops</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">prob_edge</span><span class="p">,</span><span class="n">directed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">set_edge_attributes</span><span class="p">(</span><span class="n">undirected_job</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;assigned_direction&#39;</span><span class="p">)</span>
        
        <span class="c1"># randomly define order of ops to make directed acyclic graph (DAG)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">undirected_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">undirected_job</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
        <span class="n">undirected_edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">undirected_job</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">undirected_nodes</span><span class="p">)</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="n">undirected_nodes</span>
        <span class="n">directed_job</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
        <span class="n">nodes_to_add</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">undirected_nodes</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">undirected_nodes</span><span class="p">)):</span>
            <span class="n">tail_op</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">flows</span> <span class="o">=</span> <span class="n">undirected_job</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">tail_op</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="n">flows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">undirected_job</span><span class="p">[</span><span class="n">flow</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">flow</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;assigned_direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># flow/edge not yet assigned a direction</span>
                    <span class="n">directed_job</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;op_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="s1">&#39;op_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">undirected_job</span><span class="p">[</span><span class="n">flow</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">flow</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;assigned_direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="c1"># record that added this node</span>
                    <span class="n">nodes_to_add</span><span class="p">[</span><span class="n">flow</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># edge already assigned a direction by prev op</span>
                    <span class="k">pass</span>

        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">print_data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time to define DAG order: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>
        
        <span class="c1"># if any nodes left to add, add them</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">nodes_to_add</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">nodes_to_add</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">directed_job</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;op_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">op</span><span class="p">))</span>
        <span class="n">num_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">directed_job</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">num_nodes</span> <span class="o">==</span> <span class="n">num_ops</span><span class="p">,</span> \
                <span class="s1">&#39;ERROR: DAG has </span><span class="si">{}</span><span class="s1"> nodes, but </span><span class="si">{}</span><span class="s1"> ops were specified&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">,</span><span class="n">num_ops</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">print_data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time to add left over node: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>

        <span class="c1"># connect source &amp; sink nodes to tailess &amp; headless ops respectively</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">heads_no_in_edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tails_no_out_edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">directed_job</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">directed_job</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span><span class="n">op</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">heads_no_in_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">directed_job</span><span class="o">.</span><span class="n">out_edges</span><span class="p">(</span><span class="n">op</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tails_no_out_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="n">directed_job</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">)</span>
        <span class="n">directed_job</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s1">&#39;sink&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">heads_no_in_edges</span><span class="p">:</span>
            <span class="n">directed_job</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">tails_no_out_edges</span><span class="p">:</span>
            <span class="n">directed_job</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s1">&#39;sink&#39;</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">print_data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time to connect source and sink nodes: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>

        <span class="c1"># define control and data dependency edges</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">dep_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_data_deps</span><span class="p">,</span> <span class="n">num_control_deps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">directed_job</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">dep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="n">prob_data_dependency</span><span class="p">,</span> 
                                              <span class="mi">1</span><span class="o">-</span><span class="n">prob_data_dependency</span><span class="p">])</span>
            <span class="n">directed_job</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dep_id</span><span class="o">=</span><span class="n">dep_id</span><span class="p">,</span> <span class="n">dependency</span><span class="o">=</span><span class="n">dep</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">num_data_deps</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_control_deps</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">dep_id</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">print_data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time to define control and data deps: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>

        <span class="c1"># get graph diameter</span>
        <span class="n">diameter</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">calc_graph_diameter</span><span class="p">(</span><span class="n">directed_job</span><span class="p">)</span>

        <span class="c1"># set global job attrs</span>
        <span class="n">directed_job</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;num_data_deps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_data_deps</span>
        <span class="n">directed_job</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;num_control_deps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_control_deps</span>
        <span class="n">directed_job</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;graph_diameter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diameter</span>

        <span class="k">if</span> <span class="n">jobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># doing multiprocessing, must append to manager list</span>
            <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">directed_job</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># not doing multiprocessing, return single job</span>
            <span class="k">return</span> <span class="n">directed_job</span></div>











<div class="viewcode-block" id="gen_job_event_dict"><a class="viewcode-back" href="../../../../trafpy.generator.src.html#trafpy.generator.src.jobcentric.gen_job_event_dict">[docs]</a><span class="k">def</span> <span class="nf">gen_job_event_dict</span><span class="p">(</span><span class="n">demand_data</span><span class="p">,</span> <span class="n">event_iter</span><span class="p">):</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;job&#39;</span><span class="p">][</span><span class="n">event_iter</span><span class="p">]</span>
    <span class="n">establish</span> <span class="o">=</span> <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;establish&#39;</span><span class="p">][</span><span class="n">event_iter</span><span class="p">]</span>
    <span class="n">time_arrived</span> <span class="o">=</span> <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;event_time&#39;</span><span class="p">][</span><span class="n">event_iter</span><span class="p">]</span>
    
    <span class="n">flow_stats</span> <span class="o">=</span> <span class="p">{</span><span class="n">flow</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flow</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span> 
    <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="n">flow_stats</span><span class="p">:</span>
        <span class="n">flow_stats</span><span class="p">[</span><span class="n">flow</span><span class="p">][</span><span class="s1">&#39;attr_dict&#39;</span><span class="p">][</span><span class="s1">&#39;establish&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">establish</span>
    
    <span class="n">flow_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="n">tools</span><span class="o">.</span><span class="n">gen_event_dict</span><span class="p">(</span><span class="n">flow_stats</span><span class="p">[</span><span class="n">flow</span><span class="p">][</span><span class="s1">&#39;attr_dict&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="n">flow_stats</span><span class="p">]</span>

    <span class="n">event_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;job_id&#39;</span><span class="p">:</span> <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">][</span><span class="n">event_iter</span><span class="p">],</span>
                  <span class="s1">&#39;establish&#39;</span><span class="p">:</span> <span class="n">establish</span><span class="p">,</span>
                  <span class="s1">&#39;time_arrived&#39;</span><span class="p">:</span> <span class="n">time_arrived</span><span class="p">,</span>
                  <span class="s1">&#39;time_completed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="s1">&#39;flow_dicts&#39;</span><span class="p">:</span> <span class="n">flow_dicts</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">event_dict</span></div>


<div class="viewcode-block" id="get_job_dependency_stats"><a class="viewcode-back" href="../../../../trafpy.generator.src.html#trafpy.generator.src.jobcentric.get_job_dependency_stats">[docs]</a><span class="k">def</span> <span class="nf">get_job_dependency_stats</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get stats of all dependencies in a single job and returns as a list.</span>
<span class="sd">    &#39;&#39;&#39;</span> 
    <span class="n">job_dep_stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">out_edges</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
            <span class="n">dep_stats</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">job_dep_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep_stats</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">job_dep_stats</span> </div>
            

<div class="viewcode-block" id="get_job_demand_data_dependency_stats"><a class="viewcode-back" href="../../../../trafpy.generator.src.html#trafpy.generator.src.jobcentric.get_job_demand_data_dependency_stats">[docs]</a><span class="k">def</span> <span class="nf">get_job_demand_data_dependency_stats</span><span class="p">(</span><span class="n">demand_data</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Gets stats of all dependencies of each job in demand_data. Returns these</span>
<span class="sd">    stats as a dict {job_id: dependency_stats}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">dep_stats</span> <span class="o">=</span> <span class="p">{</span><span class="n">job_id</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]}</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">])):</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;job&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">get_job_dependency_stats</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="n">dep_stats</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>

    <span class="k">return</span> <span class="n">dep_stats</span></div>




<div class="viewcode-block" id="draw_job_graph"><a class="viewcode-back" href="../../../../trafpy.generator.src.html#trafpy.generator.src.jobcentric.draw_job_graph">[docs]</a><span class="k">def</span> <span class="nf">draw_job_graph</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> 
                   <span class="n">node_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> 
                   <span class="n">font_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> 
                   <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                   <span class="n">fig_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">show_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">directed_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Draws single job graph</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pos</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">nx_agraph</span><span class="o">.</span><span class="n">graphviz_layout</span><span class="p">(</span><span class="n">job</span><span class="p">,</span><span class="n">prog</span><span class="o">=</span><span class="s1">&#39;dot&#39;</span><span class="p">,</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;source&#39;</span><span class="p">)</span>
    
    <span class="n">srcsnk</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="s1">&#39;source&#39;</span> <span class="ow">or</span> <span class="n">node</span> <span class="o">==</span> <span class="s1">&#39;sink&#39;</span><span class="p">:</span>
            <span class="n">srcsnk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">directed_graph</span><span class="p">:</span>
        <span class="n">data_deps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">control_deps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s1">&#39;dependency&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># data dependency</span>
                <span class="n">data_deps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># control dependency</span>
                <span class="n">control_deps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">15</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">,</span><span class="mi">15</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">])</span>
    <span class="c1"># nodes</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">job</span><span class="p">,</span>
                           <span class="n">pos</span><span class="p">,</span>
                           <span class="n">nodelist</span><span class="o">=</span><span class="n">srcsnk</span><span class="p">,</span>
                           <span class="n">node_size</span><span class="o">=</span><span class="n">node_size</span><span class="p">,</span>
                           <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;#47c974&#39;</span><span class="p">,</span>
                           <span class="n">linewidths</span><span class="o">=</span><span class="n">linewidths</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Source/Sink&#39;</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">job</span><span class="p">,</span>
                           <span class="n">pos</span><span class="p">,</span>
                           <span class="n">nodelist</span><span class="o">=</span><span class="n">ops</span><span class="p">,</span>
                           <span class="n">node_size</span><span class="o">=</span><span class="n">node_size</span><span class="p">,</span>
                           <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;#bd3631&#39;</span><span class="p">,</span>
                           <span class="n">linewidths</span><span class="o">=</span><span class="n">linewidths</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Op&#39;</span><span class="p">)</span>
    <span class="c1"># edges</span>
    <span class="k">if</span> <span class="n">directed_graph</span><span class="p">:</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">job</span><span class="p">,</span>
                               <span class="n">pos</span><span class="p">,</span> 
                               <span class="n">edgelist</span><span class="o">=</span><span class="n">data_deps</span><span class="p">,</span>
                               <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;#379bbf&#39;</span><span class="p">,</span>
                               <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data dependency&#39;</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">job</span><span class="p">,</span>
                               <span class="n">pos</span><span class="p">,</span>
                               <span class="n">edgelist</span><span class="o">=</span><span class="n">control_deps</span><span class="p">,</span>
                               <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                               <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Control dependency&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">job</span><span class="p">,</span>
                               <span class="n">pos</span><span class="p">,</span>
                               <span class="n">edgelist</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>
                               <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                               <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Dependency&#39;</span><span class="p">)</span>
    <span class="c1"># labels</span>
    <span class="k">if</span> <span class="n">draw_labels</span><span class="p">:</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="n">job</span><span class="p">,</span>
                                <span class="n">pos</span><span class="p">,</span> 
                                <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
                                <span class="n">font_color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                <span class="n">font_family</span><span class="o">=</span><span class="s1">&#39;sans-serif&#39;</span><span class="p">,</span>
                                <span class="n">font_weight</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span>
                                <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labelspacing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show_fig</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="draw_job_graphs"><a class="viewcode-back" href="../../../../trafpy.generator.src.html#trafpy.generator.src.jobcentric.draw_job_graphs">[docs]</a><span class="k">def</span> <span class="nf">draw_job_graphs</span><span class="p">(</span><span class="n">demand_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">job_graphs</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">node_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                    <span class="n">font_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                    <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">fig_scale</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span>
                    <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">show_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">path_to_save</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Draws list of specified job graphs. If no job graphs specified,</span>
<span class="sd">    plots all job graphs</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">job_graphs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">job_graphs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_graphs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># plot all job graphs</span>
        <span class="n">job_graphs</span> <span class="o">=</span> <span class="n">demand_data</span><span class="p">[</span><span class="s1">&#39;job&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">demand_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;must provide job demand data or list of job graphs&#39;</span>

    <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plotted_jobs</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># record plotted jobs so dont double plot est==0/1</span>
    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">job_graphs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plotted_jobs</span><span class="p">:</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">draw_job_graph</span><span class="p">(</span><span class="n">job</span><span class="p">,</span>
                                       <span class="n">node_size</span><span class="o">=</span><span class="n">node_size</span><span class="p">,</span>
                                       <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
                                       <span class="n">linewidths</span><span class="o">=</span><span class="n">linewidths</span><span class="p">,</span>
                                       <span class="n">fig_scale</span><span class="o">=</span><span class="n">fig_scale</span><span class="p">,</span>
                                       <span class="n">show_fig</span><span class="o">=</span><span class="n">show_fig</span><span class="p">,</span>
                                       <span class="n">draw_labels</span><span class="o">=</span><span class="n">draw_labels</span><span class="p">))</span>
            <span class="n">plotted_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># already plotted job</span>
            <span class="k">pass</span>

    <span class="c1"># save job graphs</span>
    <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">pickle_data</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="n">figs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">figs</span></div>

























</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Christopher W. F. Parsonson

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>